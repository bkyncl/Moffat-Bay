<!--

 Mark Witt / Brittany Kyncl
 CSD-440: Capstone Project
 Moffat-Bay Lodge - Bravo Team

-->
{% extends "reservations/base.html" %}
{% load static %}
{% block css %}
<!-- <link rel="stylesheet" type="text/css" href="{% static 'reservations/accounts.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'reservations/booking.css' %}"/>  -->
<link rel="stylesheet" type="text/css" href="{% static 'reservations/lookup.css' %}"/>
{% endblock %}
{% block content %}
<div class="banner">
    <img src="/media/site/user_banner2.jpg" alt="Image">
    <div class="overlay-lookup">
        <div class="lookup-instructions">
            <h2 class="search-heading">
                <img src="../media/site/magnifying_glass.png" alt="Logo" id="search-heading-icon">
                Search Existing Reservations
            </h2>
            <p>Please enter the 7 character confirmation number you received with your booking confirmation in
                order to view your existing reservation. If you do not have your confirmation code please 
                reach out to use via email or phone. <a href="{% url 'about_us' %}#contact_us_here">Contact us here.</a>
            </p>
            <p>If you do not see your existing reservation listed. Please reach out to us via email. Place your name,
                contact information, reservation details, and confirmation number in the email and we will be happy 
                to help.
            </p>
        </div>
        <div class="search-container">
            {% if mySearchForm.searchConfirm.errors %}
                    {% for error in mySearchForm.searchConfirm.errors %}
                        <p class="search-input-error">{{ error }}</p>
                    {% endfor %}
            {% endif %}
            <form class="search" acton="#" method="POST"> {% csrf_token %}         
                <div class="grid-item">
                    <label for="num-guests">
                        <img src="../media/site/tag.png" alt="Logo" class="label-icon">
                        Confirmation # :
                    </label>
                    {{ mySearchForm.searchConfirm }}
                </div>
                <div class="grid-item">
                    <div class="search-button-item">
                        <button id="search-button" type="submit" name="reservation_lookup_submit">
                            <img src="../media/site/white_search.png" alt="Logo" id="search-button-icon">
                            Search Now
                        </button>
                    </div> 
                </div>
            </form>
        </div>
    </div>
    {% if myReservation %}
        <div class="overlay-results">
            {% if messages %}
                {% for message in messages %}
                    {% if 'reservation-found-result' in message.tags %}
                        <h2 class="{% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</h2>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <h3>Reservation Details for: #{{searchValue}}</h3>
            <div class="res-result-container">
                <div class="room-details">
                    <img src="../media/site/{{ myReservation.roomID.size }}.png" alt="Logo" id="room-photo">
                    <div class="details-container">
                        <b>{{ myReservation.roomID.size }} Room</b>
                        <p>Sleeps 1 or {{myReservation.guests}} guest(s)</p>
                        <p>1 Bathroom</p>
                        <p>1 Kitchenette</p>
                    </div>
                </div> 
                <div class="reservation-details">
                    <div class="booking-details">
                        <p><strong>Confirmation #:</strong> <span class="price">{{myReservation.confirmationKey}}</span></p>
                        <p><strong>Reservation #:</strong> <span class="price">{{myReservation.reservationID}}</span></p>
                        <p><strong>Total Stay Cost:</strong> <span class="total-cost">${{myReservation.totalPrice}}</span></p>
                        <p><strong>Check In:</strong> {{myReservation.checkInDate}}</p>
                        <p><strong>Check Out:</strong> {{myReservation.checkOutDate}}</p>
                        <p><strong>Room Details:</strong> {{ myReservation.roomID }}</p>
                        <p><strong># of Guests:</strong> {{myReservation.guests}}</p>
                        <p><strong>Email Contact:</strong> {{myReservation.userID}}</p>
                    </div> 
                </div>
            </div>
            <form method="post" action="{% url 'delete_reservation' myReservation.reservationID %}">
                {% csrf_token %}
                <input type="hidden" name="reservation_id" value="{{ myReservation.reservationID }}">
                <button type="submit" id="cancel-booking" name="delete_reservation_button">Delete Reservation</button>
            </form>
        </div>
    {% else %}
        {% if messages %}
            {% for message in messages %}
                {% if 'not-found-result' in message.tags %}
                <div class="overlay-results" style="padding-bottom: 4vw;">
                    <h2 class="not-found {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</h2>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
</div> 
<script>
    // Add an event listener to the "Delete Reservation" button
    const deleteButton = document.querySelector('#cancel-booking');
    if (deleteButton) {
        deleteButton.addEventListener('click', async () => {
            // Your existing code to confirm deletion...

            // Send an AJAX request to the delete_reservation view
            const response = await fetch(deleteButton.form.action, {
                method: 'POST',
                body: new FormData(deleteButton.form),
            });

            // Parse the JSON response
            const result = await response.json();

            if (result.success) {
                // Deletion was successful, redirect to reservation_lookup page
                window.location.href = '{% url "reservation_lookup" %}';
            } else {
                // Handle any errors, such as authorization errors
                alert(result.message); // Display an error message to the user
            }
        });
    }
</script>
{% endblock content%}